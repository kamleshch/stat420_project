---
title: "UK Household Annual expenditure Analysis"
author: "STAT 420: Final Project, Summer 2019, kamlesh2, kdp3, pa9"
date: ''
output:
  html_document: 
    toc: yes
  pdf_document: default
urlcolor: cyan
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\
\

Loading the libraries required for this analysis
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(lmtest)
```

## Introduction to the dataset

The Living Costs and Food Survey (LCF) is an annual survey carried out in United Kingdom by [Office for National Statistics](https://www.ons.gov.uk/) since 1957. It collects data on spending pattern and the cost of living of households across UK.
\
\

<center>![](https://www.denverlibrary.org/sites/dplorg/files/united_kingdom_map2.jpg){width=300}</center>
\
\

### Data Collection Methodology

The LCF sample for Great Britain is a multi-stage stratified random sample with clustering. Address with 'small user' postcodes are drawn from the postcode address file. The LCF sample for Northern Ireland, which is part for Great Britain is collected by the central survey unit of Northern Island Statistics and Research Agency(NISRA). A systematic random sample of private addresses is drawn from the land and property service agency property database.
  
  - LCF is a continuous survey which is collected throughout the year  to ensure seasonal effects are covered. 

  - Randomly about 11,000 private households are selected each year.
  
  - Since it is completely voluntary, households can choose not to respond to the survey.
  
  - Every year on average about 50% of 11,000 households choose to respond to the survey
  
  - Volunteering household needs to fill a Household questionnaire, Individual questionnaire and dairy to track the daily expenditure for 2 weeks for all individuals aged 16 and over.
  

### Reason for this survey.

The LCF provides information for the Retail Prices Index, National Accounts estimates of household expenditure, the analysis of the effect of taxes and benefits and trends in nutrition. The results, however, are multi-purpose, providing an invaluable supply of economic and social data. 

### LCF Survey 2013

The dataset <sup>1</sup> which we are analysing in this project is teaching dataset which is a subset of LCF 2013 survey. This dataset has been simplified for the purpose of learning and teaching. This dataset has been anonymised and deposited with the [UK data service](https://ukdataservice.ac.uk) and can be found [here](https://beta.ukdataservice.ac.uk/datacatalogue/studies/study?id=7932#!/details).

LCF 2013 survey has 5,144 respondents out of which 151 were from northern Ireland. Each row in the dataset contains observations from one household.

\
\

### Purpose of study

Household spending is the amount of final consumption expenditure made by resident households to meet their everyday needs, such as food, clothing, housing (rent), energy, transport, durable goods (notably cars), health costs, leisure, and miscellaneous services. It is typically around 60% of gross domestic product (GDP) and is therefore an essential variable for economic analysis of demand <sup>2</sup>. 

Economists have traditionally relied on reported household income and expenditure as preferred indicators of poverty and living standards but the use of such indicators can be problematic. Their measurement ususally require lengthly modules and detailed questions which are not practical for households with other priorities. Also the resulting data from those modules can contain errors or reporting biases. <sup>3</sup>

As part of this study, we would like to infer the household expenditure based on income and other socioeconomic indicators of the household. The model built will be tested to determine how well it performs at predicting the expenditure of the household. 

\
\
\

## Variable definitions

The variables in the dataset are

| Variable name | Variable label                                                        | Variable type |
|---------------|-----------------------------------------------------------------------|---------------|
| casenew       | Randomly generated case number                                        | Scalar        |
| weighta       | Annual weight                                                         | Scalar        |
| P550tpr       | Total expenditure, by adults & children (top-coded)                   | Scalar        |
| P344pr        | Gross normal weekly household income (top-coded)                      | Scalar        |
| P425r         | Main source of household income                                       | Nominal       |
| A172          | Internet connection in household                                      | Nominal       |
| A093r         | Economic position of Household Reference Person                       | Nominal       |
| A094r         | NS-SEC 3 class of Household Reference Person                          | Nominal       |
| A121r         | Tenure type                                                           | Nominal       |
| SexHRP        | Sex of Household Reference Person                                     | Nominal       |
| A049r         | Number of persons in household                                        | Ordinal       |
| G018r         | Number of adults in household                                         | Ordinal       |
| G019r         | Number of children in household                                       | Ordinal       |
| Gorx          | Government Office Region - modified                                   | Nominal       |
| weightar      | Weight (rescaled)                                                     | Scalar        |
| maininc       | Main source of household income (recoded, P425-1)                     | Nominal       |
| income        | Income                                                                | Scalar        |
| expenditure   | Total expenditure (top coded, formerly P550tpr)                       | Scalar        |
| hhsize        | Household size, number of people in household (recoded)formerly A049r | Nominal       |

\
\

## Loading the dataset in R
Loading data from the tab delimited file:
```{r}
lcf_data_raw = read.table("icfforworkbook.tab", sep = "\t", header = TRUE)

colnames(lcf_data_raw)[colnames(lcf_data_raw)=="G018r"] = "noAdults"
colnames(lcf_data_raw)[colnames(lcf_data_raw)=="A049r"] = "noPersons"

# Converting to factor variable
# 1 = EarnedIncome
# 2 = OtherIncome
lcf_data_raw$incomeSource = as.factor(ifelse(lcf_data_raw$P425r==1,"EarnedIncome","OtherIncome"))

#Internet Conncetion in household
# 1 - Yes
# 2 - No
lcf_data_raw$internet = as.factor(ifelse(lcf_data_raw$A172==1, "Yes", "No"))


# Economic position of Household Reference Person
# 1 - Full-time working
# 2 - Part-time working
# 3 - Unemployed and work related Government Training Programmes
# 4 - Economically inactive
lcf_data_raw$economicHRP = as.factor(ifelse(lcf_data_raw$A093r==1,"FullTime",ifelse(lcf_data_raw$A093r==2,"PartTime",ifelse(lcf_data_raw$A093r==3,"Unemployed","EconomicallyInactive"))))


# Class of Household Reference Person
# 1 - Higher managerial, administrative and professional occupations
# 2 - Intermediate occupations
# 3 - Routine and manual occupations
# 4 - Never worked and long term unemployed, students and occupation not stated
# 5 - Not classified for other reasons
lcf_data_raw$SEC3Class = as.factor(ifelse(lcf_data_raw$A094r==1, "Class1", ifelse(lcf_data_raw$A094r==2, "Class2", ifelse(lcf_data_raw$A094r==3, "Class3", ifelse(lcf_data_raw$A094r==4, "Class4", "Class5")))))


lcf_data_raw$tenureType = as.factor(ifelse(lcf_data_raw$A121r==1, "PublicRented", ifelse(lcf_data_raw$A121r==2, "PrivateRented", "Owned")))


lcf_data_raw$sex_HRP = as.factor(ifelse(lcf_data_raw$SexHRP==1, "Male", "Female"))



lcf_data_raw$noAdults = as.factor(lcf_data_raw$noAdults)


lcf_data_raw$NoChildren = as.factor(ifelse(lcf_data_raw$G019r==1, "None", ifelse(lcf_data_raw$G019r==2, "OneChild", "TwoOrMore")))

lcf_data_raw$Gorx = as.factor(lcf_data_raw$Gorx)


lcf_data_raw = filter(lcf_data_raw,income > 0)



# select columns
cols = c("noAdults", "noPersons", "NoChildren", "income", "expenditure", "hhsize", "incomeSource", "internet", "economicHRP", "SEC3Class", "tenureType", "sex_HRP")
lcf_data = lcf_data_raw[cols]

```

\
\

Sample data:
```{r}
head(lcf_data) %>% 
  kable() %>% kable_styling(c("striped","bordered"))
```
\

The structure of the dataframe is:
```{r}
str(lcf_data)
```

\
\


Lets is if any missing values
```{r}
sum(rowSums(is.na(lcf_data))>0)
```

Above results show, no missing values

\
\

Since `expenditure` is top coded , removing top coded values.
```{r}

lcf_data = filter(lcf_data,expenditure!=max(lcf_data$expenditure))
```

\
\



```{r}
summary(lcf_data$expenditure)
ggplot(lcf_data,aes(y=expenditure,x=1))+geom_violin(fill="dodgerblue")
```

\
\


```{r,fig.height=16,fig.width=16}
#pairs(lcf_data)
```

\
\


```{r}
cor(lcf_data$hhsize,lcf_data$noPersons)

sum(!lcf_data$hhsize == lcf_data$noPersons)
```

Both variables are exactly same , removing `noPersons`
```{r}
lcf_data$noPersons=NULL
```
\
\



```{r}
# This function takes the model as the input and test 
# a) Normality 
# b) Linearity
# c) Constant variance
assumption_test = function(model){
  par(mfrow=c(1,2))
  
  # Fitted vs residual plot
  plot(fitted.values(model),resid(model),col="dodgerblue")
  abline(h=0,col="red",lwd=2)
  
  # QQ plot to test normality
  qqnorm(resid(model),col="dodgerblue")
  qqline(resid(model),lwd=2,col="red")
  
  #print(paste("Shapiro-Wilk normality test :",shapiro.test(sample(resid(model),500,replace=FALSE))$p.value))
  #print(paste("BP test for constant variance :",bptest(model)$p.value))
}
```



lets create a additive model first
```{r}
model = lm(expenditure ~ ., data = lcf_data)
summary(model)
```


Selecting only the important variables
```{r}
model = lm(expenditure ~ income + internet + tenureType + SEC3Class + hhsize, data = lcf_data)

summary(model)
```


\
\



```{r}
assumption_test(model)
```



### Log Transformation

```{r}


model_log = lm(log(expenditure)~income + internet + tenureType + SEC3Class + hhsize, data = lcf_data)
summary(model_log)

```


```{r}
assumption_test(model_log)
```


### BoxCox Transformation

```{r warning=FALSE}
library(MASS)
model =lm(expenditure ~ income + internet + tenureType + SEC3Class + hhsize, data = lcf_data)
bc=boxcox(model,lambda = seq(-3,3))
(lambda = best_lambda = bc$x[which(bc$y==max(bc$y))])
```


```{r}
model = lm(expenditure^lambda ~  income +internet + hhsize + tenureType+SEC3Class, data = lcf_data)
summary(model)
```

```{r,fig.width=8}
assumption_test(model)
```


Fitted Vs Residual plot looks ok 

```{r}
coef(summary(model))
```

```{r}
set.seed(420)
no_of_obs = nrow(lcf_data)

idx = sample(no_of_obs,no_of_obs*.80)

train = lcf_data[idx,]
test = lcf_data[-idx,]
```


```{r}
model_train = lm(expenditure^lambda ~  income +internet + hhsize + tenureType+SEC3Class, data = train)


# Train RMSE
sqrt(mean((predict(model_train)^(1/lambda) - train$expenditure)^2))
```



```{r}
# Test RMSE
sqrt(mean((predict(model_train,newdata = test)^(1/lambda) - test$expenditure)^2))

```





## References
 
<sup>1</sup> University of Manchester, Cathie Marsh Institute for Social Research (CMIST), UK Data Service, Office for National Statistics. (2019). Living Costs and Food Survey, 2013: Unrestricted Access Teaching Dataset. [data collection]. 2nd Edition. Office for National Statistics, [original data producer(s)]. Office for National Statistics. SN: 7932, [http://doi.org/10.5255/UKDA-SN-7932-2](http://doi.org/10.5255/UKDA-SN-7932-2)

<sup>2</sup> Organisation for Economic Co-operation and Development. "Household Accounts - Household Spending". oecd.org. [https://data.oecd.org/hha/household-spending.htm](https://data.oecd.org/hha/household-spending.htm) (Accessed July 21st 2019).

<sup>3</sup> D. Ferguson, B & Tandon, A & Gakidou, E & J. L. Murray, C. (2010). Estimating Permanent Income Using Indicator Variables. Health Systems Performance Assessment: Debates, Methods and Empiricism.
